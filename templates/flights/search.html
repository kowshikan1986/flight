{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Search Flights - WanderWise</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
	<style>
		body {
			background: linear-gradient(135deg, #1e3a8a, #312e81);
			min-height: 100vh;
		}
		.navbar-logo {
			height: 100px;
			width: auto;
		}
		.glass {
			background: rgba(15, 23, 42, 0.35);
			border: 1px solid rgba(255, 255, 255, 0.18);
			backdrop-filter: blur(18px);
		}
		.sheet {
			background: rgba(255, 255, 255, 0.96);
			backdrop-filter: blur(12px);
		}
	</style>
</head>
<body class="text-slate-900 flex flex-col min-h-screen">
	<nav class="bg-white/90 border-b border-white/30 backdrop-blur-md sticky top-0 z-50">
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
			<div class="flex items-center justify-between h-16">
				<a href="{% url 'home' %}" class="flex items-center gap-3">
					{% if site_settings.logo %}
						<img src="{{ site_settings.logo.url }}" alt="WanderWise logo" class="navbar-logo">
					{% else %}
						<span class="text-2xl font-semibold text-slate-800">WanderWise</span>
					{% endif %}
				</a>
				<div class="hidden md:flex items-center gap-4 text-sm font-medium">
					<a href="{% url 'flights:search' %}" class="px-3 py-2 rounded-md text-slate-900 bg-slate-100">Flights</a>
					<a href="{% url 'cars:search' %}" class="px-3 py-2 rounded-md text-slate-600 hover:text-slate-900 hover:bg-slate-100">Van Hire</a>
					{% if hotels_enabled %}
						<a href="{% url 'hotels:search' %}" class="px-3 py-2 rounded-md text-slate-600 hover:text-slate-900 hover:bg-slate-100">Hotels</a>
					{% endif %}
					{% if user.is_staff %}
						<a href="{% url 'dashboard:overview' %}" class="px-3 py-2 rounded-md text-slate-600 hover:text-slate-900 hover:bg-slate-100">Dashboard</a>
					{% endif %}
				</div>
				<div class="hidden md:flex items-center gap-3 text-sm">
					{% if user.is_authenticated %}
						<a href="{% url 'accounts:overview' %}" class="text-slate-600 hover:text-slate-900">My account</a>
						<form method="post" action="{% url 'accounts:logout' %}">
							{% csrf_token %}
							<button type="submit" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-slate-800 text-white hover:bg-slate-900">
								<i class="fas fa-sign-out-alt"></i>
								Logout
							</button>
						</form>
					{% else %}
						<a href="{% url 'accounts:login' %}" class="text-slate-600 hover:text-slate-900">Login</a>
						<a href="{% url 'accounts:register' %}" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-slate-800 text-white hover:bg-slate-900">
							<i class="fas fa-user-plus"></i>
							Register
						</a>
					{% endif %}
				</div>
				<button id="mobile-menu-button" class="md:hidden p-2 rounded-md border border-slate-200 text-slate-600">
					<i class="fas fa-bars"></i>
				</button>
			</div>
		</div>
		<div id="mobile-menu" class="md:hidden hidden glass">
			<div class="px-4 py-4 space-y-3 text-sm font-medium text-white">
				<a href="{% url 'flights:search' %}" class="block">Flights</a>
				<a href="{% url 'cars:search' %}" class="block text-slate-200 hover:text-white">Van Hire</a>
				{% if hotels_enabled %}
					<a href="{% url 'hotels:search' %}" class="block text-slate-200 hover:text-white">Hotels</a>
				{% endif %}
				{% if user.is_staff %}
					<a href="{% url 'dashboard:overview' %}" class="block text-slate-200 hover:text-white">Dashboard</a>
				{% endif %}
				{% if user.is_authenticated %}
					<a href="{% url 'accounts:overview' %}" class="block text-slate-200 hover:text-white">My account</a>
					<form method="post" action="{% url 'accounts:logout' %}">
						{% csrf_token %}
						<button type="submit" class="w-full text-left px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-900">Logout</button>
					</form>
				{% else %}
					<a href="{% url 'accounts:login' %}" class="block text-slate-200 hover:text-white">Login</a>
					<a href="{% url 'accounts:register' %}" class="block px-3 py-2 rounded-lg bg-slate-800 text-white hover:bg-slate-900">Register</a>
				{% endif %}
			</div>
		</div>
	</nav>
	{% if site_settings.custom_header %}
		<div class="bg-indigo-600/80 text-white text-center text-sm py-3">
			{{ site_settings.custom_header|safe }}
		</div>
	{% endif %}
	<main class="flex-1 py-10">
		{% if messages %}
			<div class="max-w-4xl mx-auto px-4 mb-6 space-y-3">
				{% for message in messages %}
					<div class="glass rounded-2xl px-4 py-3 text-white shadow-lg shadow-slate-900/20">
						{{ message }}
					</div>
				{% endfor %}
			</div>
		{% endif %}
		<section class="max-w-6xl mx-auto px-4">
			<div class="sheet rounded-3xl shadow-2xl border border-white/20 p-6 md:p-8">
				<div class="flex items-center gap-3 mb-6">
					<div class="w-14 h-14 rounded-2xl bg-blue-100 text-blue-600 flex items-center justify-center shadow-lg">
						<i class="fas fa-plane-departure text-xl"></i>
					</div>
					<h1 class="text-xl font-semibold text-slate-800">Plan your trip</h1>
				</div>
				<form method="get" class="space-y-6" novalidate>
					<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
						<div>
							<label for="id_origin" class="block text-sm font-medium text-slate-600 mb-1">Origin</label>
							<select id="id_origin" name="origin" class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-500">
								{% for value, label in form.origin.field.choices %}
									{% if value %}
										<option value="{{ value }}" {% if form.origin.value == value %}selected{% endif %}>{{ label }}</option>
									{% else %}
										<option value="" disabled {% if not form.origin.value %}selected{% endif %}>{{ label }}</option>
									{% endif %}
								{% endfor %}
							</select>
						</div>
						<div>
							<label for="id_destination" class="block text-sm font-medium text-slate-600 mb-1">Destination</label>
							<select id="id_destination" name="destination" class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-500">
								{% for value, label in form.destination.field.choices %}
									{% if value %}
										<option value="{{ value }}" {% if form.destination.value == value %}selected{% endif %}>{{ label }}</option>
									{% else %}
										<option value="" disabled {% if not form.destination.value %}selected{% endif %}>{{ label }}</option>
									{% endif %}
								{% endfor %}
							</select>
						</div>
						<div>
							<label for="id_departure_date" class="block text-sm font-medium text-slate-600 mb-1">Departure date</label>
							<input id="id_departure_date" name="departure_date" type="date" value="{{ form.departure_date.value|default:'' }}" class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-500">
						</div>
						<div>
							<label for="id_passenger_count" class="block text-sm font-medium text-slate-600 mb-1">Passengers</label>
							<input id="id_passenger_count" name="passenger_count" type="number" min="1" max="7" value="{{ form.passenger_count.value|default:1 }}" class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-500">
						</div>
						<div class="lg:col-span-2">
							<label class="inline-flex items-center gap-3 text-sm font-medium text-slate-600">
								<input type="checkbox" id="id_round_trip" name="round_trip" value="on" class="rounded border-slate-300 text-slate-700 focus:ring-slate-500" {% if round_trip_selected %}checked{% endif %}>
								Round trip
							</label>
						</div>
					</div>
					<div id="return-fields" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
						<div>
							<label for="id_return_date" class="block text-sm font-medium text-slate-600 mb-1">Return date</label>
							<input id="id_return_date" name="return_date" type="date" value="{{ form.return_date.value|default:'' }}" class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-500">
						</div>
						<div>
							<label for="id_return_origin" class="block text-sm font-medium text-slate-600 mb-1">Return origin</label>
							<select id="id_return_origin" name="return_origin" class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-500">
								{% for value, label in form.return_origin.field.choices %}
									{% if value %}
										<option value="{{ value }}" {% if form.return_origin.value == value %}selected{% endif %}>{{ label }}</option>
									{% else %}
										<option value="" disabled {% if not form.return_origin.value %}selected{% endif %}>{{ label }}</option>
									{% endif %}
								{% endfor %}
							</select>
						</div>
						<div>
							<label for="id_return_destination" class="block text-sm font-medium text-slate-600 mb-1">Return destination</label>
							<select id="id_return_destination" name="return_destination" class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-500">
								{% for value, label in form.return_destination.field.choices %}
									{% if value %}
										<option value="{{ value }}" {% if form.return_destination.value == value %}selected{% endif %}>{{ label }}</option>
									{% else %}
										<option value="" disabled {% if not form.return_destination.value %}selected{% endif %}>{{ label }}</option>
									{% endif %}
								{% endfor %}
							</select>
						</div>
					</div>
					<div class="flex justify-center">
						<button type="submit" class="inline-flex items-center gap-2 px-6 py-3 rounded-lg bg-slate-800 text-white font-semibold hover:bg-slate-900">
							<i class="fas fa-search"></i>
							Search flights
						</button>
					</div>
					<input type="hidden" name="return_option" value="{{ request.GET.return_option|default:'' }}">
				</form>
			</div>
		</section>
		<section class="max-w-6xl mx-auto px-4 mt-10 space-y-6">
			{% if results is not None %}
				{% if results %}
					<div class="sheet rounded-3xl border border-white/20 shadow-xl px-6 py-4">
						<p class="text-slate-700 font-semibold">Found {{ results|length }} flight{{ results|length|pluralize }} for your search.</p>
					</div>
					{% for flight in results %}
						<article class="bg-white rounded-3xl shadow-2xl border border-slate-200 p-6 md:p-8 space-y-6">
							<div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
								<div>
									<h2 class="text-2xl font-semibold text-slate-900">{{ flight.code }}</h2>
									<p class="text-slate-600">{{ flight.origin }} → {{ flight.destination }}</p>
									{% if round_trip_selected and not flight.display_return_info %}
										<p class="mt-2 text-sm text-amber-600">Return flights were unavailable for this itinerary. Showing outbound flights only.</p>
									{% endif %}
								</div>
								<div class="flex items-center gap-5 text-sm text-slate-500">
									<span class="flex items-center gap-2">
										<i class="fas fa-chair text-blue-600"></i>
										Available seats: {{ flight.available_seat_label|default_if_none:'--' }}
									</span>
									<span class="flex items-center gap-2"><i class="fas fa-user-friends text-blue-600"></i>{{ flight.requested_passenger_count }} passenger{{ flight.requested_passenger_count|pluralize }}</span>
								</div>
							</div>
							<div class="grid gap-4 {% if flight.display_return_info %}md:grid-cols-2{% else %}md:grid-cols-1{% endif %}">
								<div class="rounded-2xl bg-slate-50 border border-slate-200 p-5">
									<div class="flex items-center text-sm font-semibold text-slate-700 mb-3">
										<i class="fas fa-plane-departure text-blue-600 mr-2"></i>
										Departure details
									</div>
									<ul class="space-y-2 text-sm text-slate-600">
										<li><i class="fas fa-calendar-alt mr-2"></i>{{ flight.departure_time|date:"M d, Y" }}</li>
										<li><i class="fas fa-clock mr-2"></i>Departure {{ flight.departure_time|time:"g:i A" }}</li>
										<li><i class="fas fa-plane-arrival mr-2"></i>Arrival {{ flight.arrival_time|time:"g:i A" }} on {{ flight.arrival_time|date:"M d, Y" }}</li>
									</ul>
									<p class="mt-4 text-sm text-slate-500">Base fare per passenger</p>
									<p class="text-xl font-semibold text-slate-900">${{ flight.base_price|floatformat:2 }}</p>
								</div>
								{% if flight.display_return_info %}
									<div class="rounded-2xl bg-slate-50 border border-slate-200 p-5">
										<div class="flex items-center text-sm font-semibold text-slate-700 mb-3">
											<i class="fas fa-plane-arrival text-blue-600 mr-2"></i>
											Return details
										</div>
										{% if flight.return_flight_code %}
											<p class="text-xs font-medium text-slate-500 mb-1">Flight {{ flight.return_flight_code }}</p>
										{% endif %}
										<p class="text-sm text-slate-600 font-medium mb-2">{{ flight.return_route }}</p>
										{% if flight.return_is_alternate_date and flight.requested_return_date %}
											<p class="text-xs text-amber-600 mb-2">Closest available return departs on {{ flight.return_departure_display|date:"M d, Y" }} (requested {{ flight.requested_return_date|date:"M d, Y" }}).</p>
										{% endif %}
										<ul class="space-y-2 text-sm text-slate-600">
											<li><i class="fas fa-calendar-check mr-2"></i>{{ flight.return_departure_display|date:"M d, Y" }}</li>
											<li><i class="fas fa-clock mr-2"></i>Departure {{ flight.return_departure_display|time:"g:i A" }}</li>
											{% if flight.return_arrival_display %}
												<li><i class="fas fa-plane-arrival mr-2"></i>Arrival {{ flight.return_arrival_display|time:"g:i A" }} on {{ flight.return_arrival_display|date:"M d, Y" }}</li>
											{% endif %}
										</ul>
										<p class="mt-4 text-sm text-slate-500">Return fare per passenger</p>
										<p class="text-xl font-semibold text-slate-900">${{ flight.return_fare|floatformat:2 }}</p>
										{% if flight.additional_return_options %}
											<div class="mt-4 pt-4 border-t border-slate-200">
												<p class="text-xs uppercase tracking-wide text-slate-500 mb-2">Other return flights</p>
												<ul class="space-y-2 text-sm text-slate-600">
													{% for option in flight.additional_return_options %}
														<li class="space-y-2">
															<span class="font-semibold">{{ option.code }}</span>
															<span class="mx-1">·</span>{{ option.origin }} → {{ option.destination }}
															<span class="mx-1">·</span>{{ option.departure|date:"M d, Y" }} at {{ option.departure|time:"g:i A" }}
															<span class="mx-1">·</span>Seats: {{ option.seats_available|default_if_none:'--' }}
															{% if option.is_alternate_date %}
																<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full bg-amber-100 text-amber-700 text-xs uppercase tracking-wide">Alternate date</span>
															{% endif %}
															<form method="get" class="flex flex-wrap items-center gap-2">
																<input type="hidden" name="origin" value="{{ form.origin.value }}">
																<input type="hidden" name="destination" value="{{ form.destination.value }}">
																<input type="hidden" name="departure_date" value="{{ form.departure_date.value|default:'' }}">
																<input type="hidden" name="return_date" value="{{ form.return_date.value|default:'' }}">
																<input type="hidden" name="return_origin" value="{{ form.return_origin.value }}">
																<input type="hidden" name="return_destination" value="{{ form.return_destination.value }}">
																<input type="hidden" name="passenger_count" value="{{ form.passenger_count.value|default:1 }}">
																{% if round_trip_selected %}
																	<input type="hidden" name="round_trip" value="on">
																{% endif %}
																<input type="hidden" name="return_option" value="{{ option.identifier }}">
																<button type="submit" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-slate-300 text-sm text-slate-600 hover:bg-slate-100">
																	<i class="fas fa-check"></i>
																	Use this return flight
																</button>
															</form>
														</li>
													{% endfor %}
												</ul>
											</div>
										{% endif %}
									</div>
								{% endif %}
							</div>
							<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
								<div>
									<p class="text-xs uppercase tracking-wide text-slate-500">Estimated total</p>
									<p class="text-2xl font-semibold text-slate-900">${{ flight.estimated_total_price|floatformat:2 }}</p>
								</div>
								<a href="{% url 'flights:book' flight.id %}?passengers={{ flight.requested_passenger_count }}{% if flight.selected_return_option_identifier %}&return_option={{ flight.selected_return_option_identifier|urlencode }}{% endif %}{% if flight.requested_return_date %}&return_date={{ flight.requested_return_date|date:'Y-m-d' }}{% endif %}{% if form.return_origin.value %}&return_origin={{ form.return_origin.value|urlencode }}{% endif %}{% if form.return_destination.value %}&return_destination={{ form.return_destination.value|urlencode }}{% endif %}" class="inline-flex items-center gap-2 px-6 py-3 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700">
									<i class="fas fa-ticket-alt"></i>
									Select flight
								</a>
							</div>
						</article>
					{% endfor %}
				{% else %}
					<div class="sheet rounded-3xl border border-white/20 shadow-xl px-6 py-10 text-center space-y-3">
						<i class="fas fa-search text-4xl text-slate-400"></i>
						<h3 class="text-xl font-semibold text-slate-900">No flights found</h3>
						<p class="text-slate-600">Try changing your travel dates to see available flights.</p>
					</div>
				{% endif %}
			{% endif %}
			{% if no_results_for_query %}
				<div class="sheet rounded-3xl border border-white/20 shadow-xl px-6 py-10 text-center space-y-3">
					<i class="fas fa-calendar-times text-4xl text-slate-400"></i>
					<h3 class="text-xl font-semibold text-slate-900">No flights on this date</h3>
					<p class="text-slate-600">Please choose a different travel date to continue.</p>
				</div>
			{% endif %}
		</section>
	</main>
	<footer class="bg-white/90 border-t border-white/20">
		<div class="max-w-7xl mx-auto px-4 py-6 text-sm text-slate-500 text-center">
			&copy; {% now "Y" %} WanderWise · Need help? <a href="mailto:{{ support_email|default:'support@wanderwise.com' }}" class="text-slate-600 hover:text-slate-900">{{ support_email|default:'support@wanderwise.com' }}</a>
		</div>
	</footer>
	<script>
		document.addEventListener('DOMContentLoaded', () => {
			const mobileMenuButton = document.getElementById('mobile-menu-button');
			const mobileMenu = document.getElementById('mobile-menu');
			if (mobileMenuButton && mobileMenu) {
				mobileMenuButton.addEventListener('click', () => {
					mobileMenu.classList.toggle('hidden');
				});
			}
			const originSelect = document.getElementById('id_origin');
			const destinationSelect = document.getElementById('id_destination');
			const returnOriginSelect = document.getElementById('id_return_origin');
			const returnDestinationSelect = document.getElementById('id_return_destination');
			const roundTripCheckbox = document.getElementById('id_round_trip');
			const returnFields = document.getElementById('return-fields');
			const selectCache = new Map();
			[
				['destination', destinationSelect],
				['return_origin', returnOriginSelect],
				['return_destination', returnDestinationSelect],
			].forEach(([key, select]) => {
				if (select) {
					selectCache.set(
						key,
						Array.from(select.options).map((option) => ({
							value: option.value,
							text: option.textContent,
							isPlaceholder: option.value === '' || option.disabled,
						})),
					);
				}
			});
			const ROUTE_RULES = {
				'Katunayake (CMB)': {
					destination: ['Jaffna (JAF)'],
					return_origin: ['Jaffna (JAF)'],
					return_destination: ['Ratmalana (RMB)'],
				},
				'Jaffna (JAF)': {
					destination: ['Ratmalana (RMB)'],
					return_origin: ['Ratmalana (RMB)'],
					return_destination: ['Jaffna (JAF)'],
				},
				'Ratmalana (RMB)': {
					destination: ['Jaffna (JAF)'],
					return_origin: ['Jaffna (JAF)'],
					return_destination: ['Ratmalana (RMB)'],
				},
			};
			const applyOptions = (selectId, allowedValues) => {
				const select = document.getElementById(`id_${selectId}`);
				const optionsData = selectCache.get(selectId);
				if (!select || !optionsData) {
					return;
				}
				const normalizedAllowed = Array.isArray(allowedValues) ? allowedValues : null;
				const previousValue = select.value;
				const placeholderData = optionsData.find((option) => option.isPlaceholder);
				const filteredOptions = optionsData.filter((option) => {
					if (option.isPlaceholder) {
						return false;
					}
					return !normalizedAllowed || normalizedAllowed.includes(option.value);
				});
				select.innerHTML = '';
				let placeholderElement = null;
				if (placeholderData) {
					placeholderElement = document.createElement('option');
					placeholderElement.value = '';
					placeholderElement.textContent = placeholderData.text;
					placeholderElement.disabled = true;
					select.appendChild(placeholderElement);
				}
				filteredOptions.forEach((option) => {
					const optionElement = document.createElement('option');
					optionElement.value = option.value;
					optionElement.textContent = option.text;
					select.appendChild(optionElement);
				});
				let finalValue = previousValue;
				if (normalizedAllowed && !normalizedAllowed.includes(previousValue)) {
					finalValue = filteredOptions.length === 1 ? filteredOptions[0].value : '';
				}
				if (finalValue) {
					select.value = finalValue;
				} else if (placeholderElement) {
					placeholderElement.selected = true;
				}
			};
			const updateDestinationOptions = () => {
				const originValue = originSelect ? originSelect.value : '';
				if (originValue && ROUTE_RULES[originValue]) {
					applyOptions('destination', ROUTE_RULES[originValue].destination);
				} else {
					applyOptions('destination', null);
				}
			};
			const enforceReturnOptions = () => {
				const isRoundTrip = roundTripCheckbox ? roundTripCheckbox.checked : false;
				if (!isRoundTrip) {
					applyOptions('return_origin', null);
					applyOptions('return_destination', null);
					return;
				}
				const originValue = originSelect ? originSelect.value : '';
				const routeRule = originValue ? ROUTE_RULES[originValue] : null;
				if (routeRule) {
					applyOptions('return_origin', routeRule.return_origin);
					applyOptions('return_destination', routeRule.return_destination);
				} else {
					applyOptions('return_origin', null);
					applyOptions('return_destination', null);
				}
			};
			const toggleReturnFields = (enabled) => {
				if (!returnFields) {
					return;
				}
				returnFields.querySelectorAll('input, select').forEach((field) => {
					field.disabled = !enabled;
					field.classList.toggle('opacity-50', !enabled);
				});
			};
			if (originSelect) {
				originSelect.addEventListener('change', () => {
					updateDestinationOptions();
					enforceReturnOptions();
				});
			}
			if (roundTripCheckbox) {
				toggleReturnFields(roundTripCheckbox.checked);
				roundTripCheckbox.addEventListener('change', (event) => {
					toggleReturnFields(event.target.checked);
					enforceReturnOptions();
				});
			}
			updateDestinationOptions();
			enforceReturnOptions();
		});
	</script>
</body>
</html>
